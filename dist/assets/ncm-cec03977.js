import{R as L,c as $,s as S,i as b,r as A,j as N,N as O}from"./ncmQueue-0b48ccb8.js";const d=`${O}:`;function C(){const t=[];for(let e=0;e<localStorage.length;e++){const n=localStorage.key(e);n&&n.startsWith(d)&&t.push(n)}return t}function u(t){try{return JSON.parse(localStorage.getItem(t))}catch{return null}}function g(t,e){try{localStorage.setItem(t,JSON.stringify(e))}catch(n){console.error(n)}}function R(t){try{localStorage.removeItem(t)}catch(e){console.error(e)}}const P=document.getElementById("q"),h=document.getElementById("btnSearch"),T=document.getElementById("source"),q=document.getElementById("rows"),j=document.getElementById("status"),k=document.getElementById("btnExport"),I=document.getElementById("btnClear"),v=document.getElementById("btnBulkQueue"),i=document.getElementById("importFile"),M=document.getElementById("endpointInfo");M.textContent=`${L.NCM_API_BASE} (${L.NCM_API_TOKEN?"✔️":"sem token"})`;function U(t=[]){q.innerHTML="";for(const e of t){const n=document.createElement("tr"),c=document.createElement("td");c.textContent=e.key.replace(d,"");const o=document.createElement("td");o.textContent=e.desc||e.query||"";const r=document.createElement("td"),a=document.createElement("input");a.className="ncm-input",a.value=e.ncm||"",r.appendChild(a);const w=document.createElement("td"),y=document.createElement("button");y.textContent="Salvar";const f=document.createElement("button");f.textContent="Remover";const E=document.createElement("button");E.textContent="Consultar API",w.append(y,f,E),n.append(c,o,r,w),q.appendChild(n),y.addEventListener("click",()=>{const s=a.value.trim();if(!s)return;const l={...u(e.key)||{},desc:e.desc,query:e.query,ncm:s};g(e.key,l)}),f.addEventListener("click",()=>{R(e.key),n.remove()}),E.addEventListener("click",async()=>{var s;try{const l=e.desc||e.query||"",p=await B(l);if((s=p[0])!=null&&s.ncm){a.value=p[0].ncm;const x={...u(e.key)||{},desc:e.desc,query:e.query,ncm:p[0].ncm};g(e.key,x)}else alert("NCM não encontrado")}catch(l){console.error(l),alert("Erro na consulta API")}})}j.textContent=`${t.length} itens`}async function B(t){if(!t)return[];try{if(typeof b=="function")return(await b(t)||[]).map(n=>({key:`${d}${n.key||t}`,desc:n.desc||n.query||t,ncm:n.ncm||null,origin:"api"}));if(typeof A=="function"){const e=await A(t);return e!=null&&e.ncm?[{key:`${d}${t}`,desc:t,ncm:e.ncm,origin:"api"}]:[]}if(typeof N=="function"){const e=await N(`/search?q=${encodeURIComponent(t)}`);return(Array.isArray(e)?e:(e==null?void 0:e.items)||[]).map(c=>({key:`${d}${c.key||t}`,desc:c.desc||c.query||t,ncm:c.ncm||null,origin:"api"}))}}catch(e){console.error(e),alert("Erro na busca API")}return[]}async function m(){const t=(P.value||"").trim().toLowerCase(),n=C().filter(o=>!t||o.toLowerCase().includes(t)).map(o=>{const r=u(o)||{};return{key:o,desc:r.desc,query:r.query,ncm:r.ncm,origin:"cache"}});let c=[];t&&(c=await B(t)),T.textContent=t?"cache + api":"cache",U([...n,...c])}function _(){try{const t={};for(const c of C())t[c]=u(c);const e=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),n=document.createElement("a");n.href=URL.createObjectURL(e),n.download="ncm-cache.json",n.click(),URL.revokeObjectURL(n.href)}catch(t){console.error(t),alert("Erro ao exportar")}}i==null||i.addEventListener("change",()=>{const t=i.files[0];if(!t)return;const e=new FileReader;e.onload=()=>{try{const n=JSON.parse(e.result||"{}");if(typeof n!="object")throw new Error("Formato");for(const[c,o]of Object.entries(n))g(c,o);m()}catch(n){console.error(n),alert("JSON inválido")}},e.readAsText(t),i.value=""});function J(){try{for(const t of C())R(t);m()}catch(t){console.error(t),alert("Erro ao limpar")}}async function F(){try{await $(S.selectAllItems?S.selectAllItems():[]),alert("Fila iniciada")}catch(t){console.error(t),alert("Erro na fila")}}h==null||h.addEventListener("click",m);k==null||k.addEventListener("click",_);I==null||I.addEventListener("click",J);v==null||v.addEventListener("click",F);window.addEventListener("DOMContentLoaded",m);
