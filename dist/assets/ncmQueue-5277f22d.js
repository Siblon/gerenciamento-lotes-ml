(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))c(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&c(a)}).observe(document,{childList:!0,subtree:!0});function n(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function c(o){if(o.ep)return;o.ep=!0;const s=n(o);fetch(o.href,s)}})();const Z="ncmCache:v1",b={NCM_API_BASE:{}.VITE_NCM_API_BASE||"https://portalunico.siscomex.gov.br/classif/api/publico",NCM_API_TOKEN:{}.VITE_NCM_API_TOKEN||"",NCM_LOCAL_MAP_URL:"/data/ncm.json",CACHE_KEY:Z},r={currentRZ:null,rzAtual:null,rzList:[],itemsByRZ:{},totalByRZSku:{},metaByRZSku:{},conferidosByRZSku:{},contadores:{},movimentos:[],excedentes:{},limits:{conferidos:50,pendentes:50},ncmCache:(()=>{try{return JSON.parse(localStorage.getItem(Z)||"{}")}catch{return{}}})(),ncmState:{running:!1,done:0,total:0},itemTags:{}};function S(t){const e=r.totalByRZSku[t]||{},n=r.conferidosByRZSku[t]||{},c=Object.keys(e).length,o=Object.keys(n).filter(a=>{var u;return(((u=n[a])==null?void 0:u.qtd)||0)>=(e[a]||0)}).length,s=(r.excedentes[t]||[]).length;r.contadores[t]={conferidos:o,total:c,excedentes:s}}function mt(t){r.currentRZ=r.rzAtual=t,t&&S(t)}function $(t=[]){r.rzList=Array.isArray(t)?t:[],r.currentRZ||(r.currentRZ=r.rzList[0]||null),r.currentRZ&&S(r.currentRZ)}function U(t=[]){var s,a,u;const e={},n={},c={},o=Date.now();for(const i of t){(e[s=i.codigoRZ]||(e[s]=[])).push(i);const f=String(i.codigoML||"").trim().toUpperCase();if(!f)continue;n[a=i.codigoRZ]||(n[a]={});const m=Number(i.qtd)||0;if(n[i.codigoRZ][f]=(n[i.codigoRZ][f]||0)+m,c[u=i.codigoRZ]||(c[u]={}),!c[i.codigoRZ][f]){const d=String(i.descricao||"").trim(),p=Number(i.valorUnit||0),l=i.ncm||null,y={descricao:d,precoMedio:p,ncm:l};if(l){const g=o;y.ncm_source="row",y.ncm_ts=g,y.ncmMeta={source:"row",ts:g,status:"ok"},y.ncm_status="ok",i.ncmMeta={source:"row",ts:g,status:"ok"},r.ncmCache[f]=l}c[i.codigoRZ][f]=y}}r.itemsByRZ=e,r.totalByRZSku=n,r.metaByRZSku=c,r.conferidosByRZSku={},r.excedentes={},r.currentRZ||(r.currentRZ=Object.keys(e)[0]||null);try{localStorage.setItem(Z,JSON.stringify(r.ncmCache))}catch{}return{itemsByRZ:e,totalByRZSku:n,metaByRZSku:c}}function pt(t){return r.totalByRZSku[t]||{}}function yt(t){return r.conferidosByRZSku[t]||{}}function O(t,e,n={}){var f,m;const c=(f=r.conferidosByRZSku)[t]||(f[t]={}),o=((m=r.totalByRZSku[t])==null?void 0:m[e])||0,s=Math.max(1,parseInt(n.qty??1,10)),a=c[e]||{qtd:0,precoAjustado:null,observacao:null,status:null,avariados:0},u=Math.max(0,o-a.qtd),i=Math.min(s,u);i<=0||(a.qtd+=i,n.precoAjustado!==void 0&&(a.precoAjustado=n.precoAjustado),n.observacao&&(a.observacao=n.observacao),n.avaria&&(a.status="avariado",a.avariados=(a.avariados||0)+i),c[e]=a,r.movimentos.push({ts:Date.now(),rz:t,sku:e,qty:i,precoAjustado:a.precoAjustado,observacao:a.observacao,status:a.status}),S(t))}function K(t,e){return!!(r.totalByRZSku[t]||{})[e]}function J(t,e){var o,s,a;const n=((o=r.totalByRZSku[t])==null?void 0:o[e])||0;return(((a=(s=r.conferidosByRZSku[t])==null?void 0:s[e])==null?void 0:a.qtd)||0)>=n&&n>0}function G(t,e){var s,a,u;const n=r.totalByRZSku[t]||{};if(!n[e])return null;const c=((a=(s=r.conferidosByRZSku[t])==null?void 0:s[e])==null?void 0:a.qtd)||0;if(c>=n[e])return null;const o=((u=r.metaByRZSku[t])==null?void 0:u[e])||{};return{sku:e,descricao:o.descricao||"",qtd:n[e]-c,precoMedio:o.precoMedio,ncm:o.ncm??null}}function H(t,e){var o,s;const n=(o=r.conferidosByRZSku[t])==null?void 0:o[e];if(!n)return null;const c=((s=r.metaByRZSku[t])==null?void 0:s[e])||{};return{sku:e,descricao:c.descricao||"",qtd:n.qtd||0,precoMedio:c.precoMedio,ncm:c.ncm??null}}function Y(t){for(const[e,n]of Object.entries(r.totalByRZSku||{}))if(e!==r.rzAtual&&n[t])return e;return null}function j(t,{sku:e,descricao:n,qtd:c,preco:o,obs:s,fonte:a,ncm:u}){var l,y,g;const i=(l=r.excedentes)[t]||(l[t]=[]),f=i.find(h=>h.sku===e),m=Number(c)||0,d=o==null||o===""?void 0:Number(o),p=u??((g=(y=r.metaByRZSku[t])==null?void 0:y[e])==null?void 0:g.ncm)??null;f?(f.qtd+=m,d!==void 0&&(f.preco=d),f.obs=s||f.obs,f.ncm=p??f.ncm??null):i.push({sku:e,descricao:n||"",qtd:m,preco:d,obs:s||"",fonte:a||"",ncm:p}),r.movimentos.push({ts:Date.now(),tipo:"EXCEDENTE",rz:t,sku:e,qtd:m,preco:d,obs:s,fonte:a}),S(t)}function F(t,e,n,c=1){var i,f,m;const o=Number(c)||0,s=r.totalByRZSku[t]||{},a=(i=r.totalByRZSku)[e]||(i[e]={});s[n]&&(s[n]-=o,s[n]<=0&&delete s[n]),a[n]=(a[n]||0)+o;const u=(f=r.metaByRZSku[t])==null?void 0:f[n];u&&((m=r.metaByRZSku)[e]||(m[e]={}),r.metaByRZSku[e][n]=u),S(t),S(e)}function Q(t){if((t==null?void 0:t.type)==="REGISTRAR"){const{rz:e,sku:n,qty:c,precoAjustado:o,observacao:s}=t;O(e,n,{qty:c,precoAjustado:o,observacao:s})}}function V(t,e={}){const n=r.rzAtual;O(n,t,{qty:e.qty,precoAjustado:e.price,observacao:e.note,avaria:e.avaria})}function W({sku:t,qty:e,price:n,note:c}){const o=r.rzAtual;j(o,{sku:t,descricao:"",qtd:e,preco:n,obs:c,fonte:"preset"})}function E(t){const[e,n]=String(t||"").split(":");return{rz:e,sku:n}}function P(t,e){var o;const n=(o=r.conferidosByRZSku)[t]||(o[t]={}),c=n[e]||(n[e]={qtd:0,precoAjustado:null,observacao:null,status:null,avariados:0});return c.flags||(c.flags={}),c}function X(t,e,n=""){const{rz:c,sku:o}=E(t);if(!c||!o)return;const s=P(c,o);e?(s.flags.excedente=!0,s.obs_excedente=n||""):(delete s.flags.excedente,delete s.obs_excedente)}function z(t,e,n=""){const{rz:c,sku:o}=E(t);if(!c||!o)return;const s=P(c,o),a=Number(s.qtd||0),u=Math.max(0,Math.min(Number(e)||0,a));s.qtd_descarte=u,s.obs_descarte=n||"",u>0?s.flags.descarte=!0:delete s.flags.descarte}function tt(){var e,n;const t=[];for(const[c,o]of Object.entries(r.conferidosByRZSku||{}))for(const[s,a]of Object.entries(o||{}))if((e=a==null?void 0:a.flags)!=null&&e.descarte&&a.qtd_descarte>0){const u=((n=r.metaByRZSku[c])==null?void 0:n[s])||{};t.push({rz:c,sku:s,descricao:u.descricao||"",qtd_descartada:a.qtd_descarte,obs:a.obs_descarte||""})}return t}function T(t,e,n){var i,f;const{rz:c,sku:o}=E(t);if(!c||!o)return;(i=r.metaByRZSku)[c]||(i[c]={});const s=(f=r.metaByRZSku[c])[o]||(f[o]={}),a=Date.now();s.ncm=e,s.ncm_source=n,s.ncm_ts=a,s.ncmMeta={source:n,ts:a,status:"ok"},s.ncm_status="ok";const u=(r.itemsByRZ[c]||[]).find(m=>String(m.codigoML||"").toUpperCase()===o);u&&(u.ncm=e,u.ncmMeta={source:n,ts:a,status:"ok"}),r.ncmCache[o]=e;try{localStorage.setItem(Z,JSON.stringify(r.ncmCache))}catch{}typeof document<"u"&&document.dispatchEvent(new Event("ncm-update"))}function A(t,e){var a;const{rz:n,sku:c}=E(t),o=(a=r.metaByRZSku[n])==null?void 0:a[c];o&&(o.ncm_status=e,(o.ncmMeta||(o.ncmMeta={})).status=e);const s=(r.itemsByRZ[n]||[]).find(u=>String(u.codigoML||"").toUpperCase()===c);s&&((s.ncmMeta||(s.ncmMeta={})).status=e),typeof document<"u"&&document.dispatchEvent(new Event("ncm-update"))}function et(t,e){var c;((c=r.itemTags)[t]||(c[t]=new Set)).add(e)}function nt(t,e){const n=r.itemTags[t];n&&(n.delete(e),n.size===0&&delete r.itemTags[t])}function ot(){const t=r.currentRZ,e=[],n=r.totalByRZSku[t]||{},c=r.metaByRZSku[t]||{};for(const s of Object.keys(n))e.push({id:`${t}:${s}`,sku:s,...c[s]||{}});const o=r.excedentes[t]||[];for(const s of o)e.push({id:`${t}:${s.sku}`,...s});return e}function ct(){var e,n,c;const t=[];for(const[o,s]of Object.entries(r.totalByRZSku||{})){const a=r.metaByRZSku[o]||{};for(const[u,i]of Object.entries(s))t.push({rz:o,sku:u,descricao:((e=a[u])==null?void 0:e.descricao)||"",preco_ml_unit:Number(((n=a[u])==null?void 0:n.precoMedio)||0),qtd:Number(i||0),ncm:((c=a[u])==null?void 0:c.ncm)||null})}return t}const R={state:r,dispatch:Q,getSkuInRZ:K,isConferido:J,findInRZ:G,findConferido:H,addExcedente:j,findEmOutrosRZ:Y,moveItemEntreRZ:F,conferir:V,registrarExcedente:W,setItemNcm:T,setItemNcmStatus:A,tagItem:et,untagItem:nt,selectAllItems:ot,selectAllImportedItems:ct,setExcedente:X,setDescarte:z,selectDescartes:tt,setRZs:$,setItens:U},_=Z,C=new Map,v=new Map;let N;const st=new Set(["de","do","da","para","com","a","o","e","em","no","na","dos","das"]);function w(t){const e=String(t??"").replace(/\D/g,"");return/^\d{8}$/.test(e)?e:null}function k(t){return String(t||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^\w\s]+/g," ").replace(/\s+/g," ").trim()}function q(t){return k(t).split(" ").filter(e=>e&&!st.has(e))}function rt(t){if(C.has(t))return C.get(t);try{const n=JSON.parse(localStorage.getItem(_)||"{}")[t];if(n)return C.set(t,n),n}catch(e){console.warn("cacheGet error",{key:t,err:e})}return null}function I(t,e){C.set(t,e);try{const n=JSON.parse(localStorage.getItem(_)||"{}");n[t]=e,localStorage.setItem(_,JSON.stringify(n))}catch(n){console.warn("cacheSet error",{key:t,err:n})}}async function at(){return N||(N=fetch(b.NCM_LOCAL_MAP_URL).then(t=>t.ok?t.json():{}).then(t=>{const e={};for(const[n,c]of Object.entries(t||{}))e[k(n)]=c;return e}).catch(()=>({}))),N}function x(t,e={}){const c=`${(b.NCM_API_BASE||"").replace(/\/$/,"")}${t}`,o={...e.headers,...b.NCM_API_TOKEN?{Authorization:`Bearer ${b.NCM_API_TOKEN}`}:{}};return fetch(c,{...e,headers:o})}async function it(t){const e=/^\d{8}$/.test(t),n=e?`codigo=${encodeURIComponent(t)}`:`descricao=${encodeURIComponent(t)}`,c=e?[]:q(t),o=async()=>{const s=new AbortController,a=setTimeout(()=>s.abort(),4e3);try{const u=`/ncm?${n}`,i=await x(u,{signal:s.signal});if(!i.ok){const d=new Error("http "+i.status);throw i.status>=500&&(d.retry=!0),d}const f=await i.json(),m=Array.isArray(f)?f:[f];if(e){const d=w(t);return{ncm:m.find(l=>w(l.codigoNcm||l.codigo)===d)?d:null,raw:f}}else{let d=null,p=0;for(const l of m){const y=w(l.codigoNcm||l.codigo);if(!y)continue;const g=q(l.descricao||""),h=c.reduce((L,D)=>L+(g.includes(D)?1:0),0);h>=2&&h>p&&(d={ncm:y,raw:l,score:h},p=h)}return{ncm:d?d.ncm:null,raw:f}}}finally{clearTimeout(a)}};for(let s=0;s<3;s++)try{return await o()}catch(a){if(!a.retry||s===2)throw a;await new Promise(u=>setTimeout(u,500*(s+1)))}}async function ut(t,e,{onlyCache:n=!1}={}){const c=performance.now?performance.now():Date.now(),o=rt(e);if(o)return(performance.now?performance.now():Date.now())-c,{ncm:o.ncm,source:"cache",status:"ok"};const a=(await at())[e],u=w(a);if(u){const i={ncm:u,source:"map",ts:Date.now()};return I(e,i),(performance.now?performance.now():Date.now())-c,{ncm:u,source:"map",status:"ok"}}if(n)return(performance.now?performance.now():Date.now())-c,{ncm:null,source:"cache",status:"falha"};try{const{ncm:i,raw:f}=await it(t),m=(performance.now?performance.now():Date.now())-c;if(i){const d={ncm:i,source:"api",ts:Date.now()};return I(e,d),{ncm:i,source:"api",status:"ok",raw:f}}return{ncm:null,source:"api",status:"falha",raw:f}}catch{return(performance.now?performance.now():Date.now())-c,{ncm:null,source:"api",status:"falha"}}}async function M(t,e={}){const n=k(t);if(v.has(n))return v.get(n);const c=ut(t,n,e).finally(()=>v.delete(n));return v.set(n,c),c}async function ft(t){if(typeof t=="string")return M(t);const e=t==null?void 0:t.sku,n=t==null?void 0:t.descricao;if(e){const c=await M(e,{onlyCache:!0});if(c.status==="ok")return c}return n?M(n):{ncm:null,source:"cache",status:"falha"}}async function gt(t){const e=await x(`/search?q=${encodeURIComponent(t)}`);if(!e.ok)throw new Error("http "+e.status);const n=await e.json();return(Array.isArray(n)?n:Array.isArray(n.items)?n.items:[]).map(o=>({desc:o.desc??o.descricao??o.description??o.query??"",query:o.query??o.desc??o.descricao??o.description??"",ncm:w(o.ncm??o.code??o.codigo??o.codigoNcm),code:w(o.code??o.codigo??o.codigoNcm??o.ncm)}))}async function dt(t,e=3,n=500){let c;for(let o=0;o<e;o++)try{return await t()}catch(s){c=s,o<e-1&&await new Promise(a=>setTimeout(a,n*Math.pow(2,o)))}throw c}let B=!1;typeof document<"u"&&document.addEventListener("ncm-cancel",()=>{B=!0});function lt(t,e){return Promise.race([t,new Promise((n,c)=>setTimeout(()=>c(new Error("timeout")),e))])}async function ht(t=[]){B=!1;const e=t.filter(d=>!d.ncm).map(d=>({id:`${d.codigoRZ}:${d.codigoML}`,it:d})),n=e.length;let c=0;R.state.ncmState={running:n>0,done:c,total:n};const o=typeof document<"u";if(o&&document.dispatchEvent(new CustomEvent("ncm-progress",{detail:{done:c,total:n}})),!n)return;const s=e.slice(),a=[],u=3;let i=0,f=null;async function m(){for(;s.length&&!B;){f&&await f;const{id:d,it:p}=s.shift();try{A(d,"pendente");const l=await dt(()=>lt(ft({sku:p.codigoML,descricao:p.descricao}),4e3),3,500);l.status==="ok"&&l.ncm?(p.ncm=l.ncm,T(d,l.ncm,l.source),i=0):(A(d,"falha"),i++)}catch{A(d,"falha"),i++}finally{c++,R.state.ncmState={running:!0,done:c,total:n},o&&document.dispatchEvent(new CustomEvent("ncm-progress",{detail:{done:c,total:n}}))}i>10&&!f&&(console.warn("API instável; tentando novamente em 30s"),R.state.ncmState={running:!0,done:c,total:n,paused:!0},o&&document.dispatchEvent(new CustomEvent("ncm-progress",{detail:{done:c,total:n,paused:!0}})),f=new Promise(l=>setTimeout(()=>{f=null,R.state.ncmState={running:!0,done:c,total:n,paused:!1},o&&document.dispatchEvent(new CustomEvent("ncm-progress",{detail:{done:c,total:n,paused:!1}})),i=0,l()},3e4)),await f)}}for(let d=0;d<Math.min(u,n);d++)a.push(m());await Promise.all(a),R.state.ncmState={running:!1,done:c,total:n},o&&document.dispatchEvent(new CustomEvent("ncm-progress",{detail:{done:c,total:n}}))}export{Z as N,b as R,U as a,ht as b,mt as c,R as d,j as e,H as f,Y as g,yt as h,pt as i,gt as j,x as k,F as m,ft as r,$ as s};
