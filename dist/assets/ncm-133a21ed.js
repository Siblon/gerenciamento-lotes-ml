import{R as I,i as B,j as v,k as C,r as g,l as b,N}from"./ncmQueue-9e98224f.js";const i=`${N}:`;function h(){const e=[];for(let t=0;t<localStorage.length;t++){const n=localStorage.key(t);n&&n.startsWith(i)&&e.push(n)}return e}function d(e){try{return JSON.parse(localStorage.getItem(e))}catch{return null}}function p(e,t){try{localStorage.setItem(e,JSON.stringify(t))}catch(n){console.error(n)}}function L(e){try{localStorage.removeItem(e)}catch(t){console.error(t)}}const q=document.getElementById("q"),x=document.getElementById("btnSearch"),R=document.getElementById("source"),w=document.getElementById("rows"),$=document.getElementById("status"),O=document.getElementById("btnExport"),P=document.getElementById("btnClear"),T=document.getElementById("btnBulkQueue"),E=document.getElementById("importFile"),j=document.getElementById("endpointInfo");j.textContent=`${I.NCM_API_BASE} (${I.NCM_API_TOKEN?"✔️":"sem token"})`;function M(e=[]){w.innerHTML="";for(const t of e){const n=document.createElement("tr"),c=document.createElement("td");c.textContent=t.key.replace(i,"");const r=document.createElement("td");r.textContent=t.desc||t.query||"";const o=document.createElement("td"),s=document.createElement("input");s.className="ncm-input",s.value=t.ncm||"",o.appendChild(s);const k=document.createElement("td"),m=document.createElement("button");m.textContent="Salvar";const y=document.createElement("button");y.textContent="Remover";const f=document.createElement("button");f.textContent="Consultar API",k.append(m,y,f),n.append(c,r,o,k),w.appendChild(n),m.addEventListener("click",()=>{const a=s.value.trim();if(!a)return;const l={...d(t.key)||{},desc:t.desc,query:t.query,ncm:a};p(t.key,l)}),y.addEventListener("click",()=>{L(t.key),n.remove()}),f.addEventListener("click",async()=>{try{const a=t.desc||t.query||"",l=await S(a);if(l[0]?.ncm){s.value=l[0].ncm;const A={...d(t.key)||{},desc:t.desc,query:t.query,ncm:l[0].ncm};p(t.key,A)}else alert("NCM não encontrado")}catch(a){console.error(a),alert("Erro na consulta API")}})}$.textContent=`${e.length} itens`}async function S(e){if(!e)return[];try{if(typeof C=="function")return(await C(e)||[]).map(n=>({key:`${i}${n.key||e}`,desc:n.desc||n.query||e,ncm:n.ncm||null,origin:"api"}));if(typeof g=="function"){const t=await g(e);return t?.ncm?[{key:`${i}${e}`,desc:e,ncm:t.ncm,origin:"api"}]:[]}if(typeof b=="function"){const t=await b(`/search?q=${encodeURIComponent(e)}`);return(Array.isArray(t)?t:t?.items||[]).map(c=>({key:`${i}${c.key||e}`,desc:c.desc||c.query||e,ncm:c.ncm||null,origin:"api"}))}}catch(t){console.error(t),alert("Erro na busca API")}return[]}async function u(){const e=(q.value||"").trim().toLowerCase(),n=h().filter(r=>!e||r.toLowerCase().includes(e)).map(r=>{const o=d(r)||{};return{key:r,desc:o.desc,query:o.query,ncm:o.ncm,origin:"cache"}});let c=[];e&&(c=await S(e)),R.textContent=e?"cache + api":"cache",M([...n,...c])}function F(){try{const e={};for(const c of h())e[c]=d(c);const t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),n=document.createElement("a");n.href=URL.createObjectURL(t),n.download="ncm-cache.json",n.click(),URL.revokeObjectURL(n.href)}catch(e){console.error(e),alert("Erro ao exportar")}}E?.addEventListener("change",()=>{const e=E.files[0];if(!e)return;const t=new FileReader;t.onload=()=>{try{const n=JSON.parse(t.result||"{}");if(typeof n!="object")throw new Error("Formato");for(const[c,r]of Object.entries(n))p(c,r);u()}catch(n){console.error(n),alert("JSON inválido")}},t.readAsText(e),E.value=""});function U(){try{for(const e of h())L(e);u()}catch(e){console.error(e),alert("Erro ao limpar")}}async function _(){try{await B(v.selectAllItems?v.selectAllItems():[]),alert("Fila iniciada")}catch(e){console.error(e),alert("Erro na fila")}}x?.addEventListener("click",u);O?.addEventListener("click",F);P?.addEventListener("click",U);T?.addEventListener("click",_);window.addEventListener("DOMContentLoaded",u);
