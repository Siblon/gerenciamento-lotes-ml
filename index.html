<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Sistema de Conferência</title>
</head>
<body>
  <main class="container">
    <header class="toolbar">
      <h1>
        Conferência de Lotes <span id="hdr-conferidos">0 de 0 conferidos</span>
      </h1>
      <div id="kpis-host"></div>
      <div class="actions">
        <a href="/ncm.html" title="Console de NCM" class="btn btn-ghost">NCM</a>
        <label class="switch" style="display:inline-flex;gap:8px;align-items:center">
          <input type="checkbox" id="resolve-ncm" />
          <span>Resolver NCM</span>
        </label>
        <button id="helpBtn" title="Ajuda/Atalhos" aria-label="Ajuda" class="btn btn-ghost">?</button>
        <button id="btn-download-backup" class="btn btn-ghost">Baixar backup</button>
      </div>
    </header>

    <section id="indicadores" class="indicators hidden">
      <div class="indicators-toolbar">
        <button id="toggle-indicators">Mostrar indicadores</button>
        <button id="config-indicators" title="Configurar indicadores">⚙️</button>
      </div>
      <div class="indicators-grid"></div>
    </section>

    <div class="page">
      <div class="main-col">
        <section id="card-importacao" class="card">
          <div class="card-header">
            <h2>Importação &amp; Seleção</h2>
          </div>
          <div class="card-body">
            <div class="file-row">
              <label class="label" for="file">Planilha</label>
              <div class="file-input-wrap">
                <input type="file" id="file" accept=".xlsx" />
                <span id="file-name" class="file-name ellipsis"></span>
              </div>
            </div>
            <div class="field">
              <label for="select-rz" class="label">RZ</label>
              <select id="select-rz" class="input"></select>
              <span id="ncm-badge" class="badge" hidden>Resolvendo NCM… <span id="ncm-badge-count">0/0</span></span>
            </div>
            <div class="field">
              <label for="select-lote" class="label">Lote</label>
              <div id="lot-selector-host"></div>
            </div>
            <div class="field">
              <label class="label" for="btn-export">&nbsp;</label>
              <button id="btn-export" class="btn btn-primary">Exportar</button>
            </div>
          </div>
        </section>

        <section id="card-acoes" class="card">
          <div class="card-header">
            <h2>Ações de Conferência</h2>
          </div>
          <div class="card-body">
            <div class="actions-grid">
              <div class="row">
                <div class="field">
                  <label for="input-codigo-produto" class="label">Código do produto</label>
                  <input type="text" id="input-codigo-produto" placeholder="Código do produto" class="input" />
                </div>
                <div class="field">
                  <label class="label" for="btn-consultar">&nbsp;</label>
                  <button id="btn-consultar" class="btn btn-primary" type="button">Consultar</button>
                </div>
                <div class="field">
                  <label class="label" for="btn-open-scanner">&nbsp;</label>
                  <button id="btn-open-scanner" type="button" class="btn btn-ghost" aria-controls="card-scanner" aria-expanded="false">Ler código</button>
                </div>
              </div>
              <div class="row">
                <div class="field">
                  <label for="obs-preset" class="label">Observação (pré-definida)</label>
                  <select id="obs-preset" class="input" aria-label="Observação padrão">
                    <option value="">— Nenhuma —</option>
                    <option value="excedente">Produto excedente (não listado)</option>
                  </select>
                </div>
                <div class="field">
                  <label for="preco-ajustado" class="label">Preço</label>
                  <input type="number" id="preco-ajustado" placeholder="Preço" step="0.01" class="input" />
                </div>
                <div class="field">
                  <label class="label" for="btn-registrar">&nbsp;</label>
                  <button id="btn-registrar" class="btn btn-primary" type="button">Registrar</button>
                </div>
              </div>
            </div>

            <section id="produto-info" class="card" hidden>
              <div class="card-header">
                <strong id="pi-sku">SKU</strong> — <span id="pi-desc">Descrição</span>
              </div>
              <div class="card-body">
                <div class="kv"><span class="muted">Qtd</span><span id="pi-qtd">0</span></div>
                <div class="kv"><span class="muted">Preço médio (R$)</span><span id="pi-preco">0,00</span></div>
                <div class="kv"><span class="muted">Valor total (R$)</span><span id="pi-total">0,00</span></div>
                <div class="kv"><span class="muted">RZ</span><span id="pi-rz">—</span></div>
                <div class="kv"><span class="muted">NCM</span><span id="pi-ncm">—</span></div>
              </div>
            </section>
          </div>
        </section>

        <section id="finance-panel" class="card collapsed">
          <header class="card-header">
            <h3>Financeiro</h3>
            <div class="spacer"></div>
            <label class="switch">
              <input type="checkbox" id="toggle-finance" />
              <span>Mostrar</span>
            </label>
          </header>
          <div class="card-body">
            <div class="field">
              <label for="fin-percent" class="label">Pagamos % do preço ML</label>
              <input type="range" id="fin-percent" min="0" max="50" step="1" class="input" />
              <span id="fin-percent-val">20%</span>
            </div>
            <div class="field">
              <label for="fin-desconto" class="label">Desconto venda vs ML</label>
              <input type="range" id="fin-desconto" min="0" max="50" step="1" class="input" />
              <span id="fin-desconto-val">20%</span>
            </div>
            <div class="field">
              <label for="fin-frete" class="label">Frete total</label>
              <input type="number" id="fin-frete" class="input" step="0.01" />
            </div>
            <div class="field">
              <label for="fin-mode" class="label">Cálculo do frete</label>
              <select id="fin-mode" class="input">
                <option value="finalizar">apenas ao finalizar</option>
                <option value="ao_vivo">ao vivo</option>
              </select>
            </div>
            <div class="field">
              <label for="fin-rateio" class="label">Rateio do frete</label>
              <select id="fin-rateio" class="input">
                <option value="valor">por valor</option>
                <option value="quantidade">por quantidade</option>
              </select>
            </div>
          </div>
        </section>

        <div class="actions">
          <button id="finalizarBtn" class="btn btn-ghost">Finalizar Conferência</button>
        </div>

        <section id="card-scanner" class="card collapsed" aria-live="polite">
          <div class="card-header">
            <h2>Scanner</h2>
          </div>
          <div class="card-body">
            <select id="scan-mode" class="input">
              <option value="wedge">Leitor</option>
              <option value="camera">Câmera</option>
            </select>
            <button id="btn-scan-toggle" type="button" class="btn" aria-pressed="false">Ativar Scanner</button>
            <video id="preview" playsinline muted aria-hidden="true"></video>
          </div>
        </section>

        <section id="card-resultados" class="card">
          <div class="card-header">
            <h2>Resultados</h2>
          </div>
          <div class="card-body">
            <section id="resumos">
              <div id="resumoRZ"></div>
              <div id="resumoGeral"></div>
            </section>

            <section id="listas">
              <!-- Conferidos -->
              <section id="sec-conferidos" class="section card">
                <div class="card-header">
                  <h2>Conferidos <span id="count-conferidos">0</span></h2>
                  <div class="actions">
                    <select id="limit-conferidos" class="input" aria-label="Limite de conferidos">
                      <option>25</option>
                      <option selected>50</option>
                      <option>100</option>
                      <option>200</option>
                    </select>
                    <button id="btn-recolher-conferidos" data-target="sec-conferidos" class="btn btn-ghost">Recolher</button>
                  </div>
                </div>
                <div class="card-body">
                  <div class="table-wrap">
                    <table id="tbl-conferidos">
                      <thead>
                        <tr>
                          <th class="sticky">SKU</th>
                          <th>Descrição</th>
                          <th class="num">Qtd</th>
                          <th class="num">Preço Médio (R$)</th>
                          <th class="num">Valor Total (R$)</th>
                          <th>Status</th>
                        </tr>
                      </thead>
                      <tbody></tbody>
                    </table>
                  </div>
                </div>
              </section>

              <!-- Pendentes -->
              <section id="sec-pendentes" class="section card">
                <div class="card-header">
                  <h2>Pendentes <span id="count-pendentes">0</span></h2>
                  <div class="actions">
                    <select id="limit-pendentes" class="input" aria-label="Limite de pendentes">
                      <option>25</option>
                      <option selected>50</option>
                      <option>100</option>
                      <option>200</option>
                    </select>
                    <button id="btn-recolher-pendentes" data-target="sec-pendentes" class="btn btn-ghost">Recolher</button>
                  </div>
                </div>
                <div class="card-body">
                  <div class="table-wrap">
                    <table id="tbl-pendentes">
                      <thead>
                        <tr>
                          <th class="sticky">SKU</th>
                          <th>Descrição</th>
                          <th class="num">Qtd</th>
                          <th class="num">Preço Médio (R$)</th>
                          <th class="num">Valor Total (R$)</th>
                          <th>Status</th>
                        </tr>
                      </thead>
                      <tbody></tbody>
                    </table>
                  </div>
                </div>
              </section>

              <!-- Excedentes -->
              <section id="sec-excedentes" class="section card">
                <div class="card-header">
                  <h2>Excedentes <span id="excedentesCount">0</span></h2>
                  <div class="actions">
                    <button id="btn-recolher-excedentes" data-target="sec-excedentes" class="btn btn-ghost">Recolher</button>
                  </div>
                </div>
                <div class="card-body">
                  <div class="lista-controles">
                    <input class="lista-search input" data-list="excedentes" placeholder="Buscar por SKU ou descrição" aria-label="Buscar por SKU ou descrição" />
                    <select class="lista-pagesize input" data-list="excedentes" aria-label="Itens por página">
                      <option value="20">20</option>
                      <option value="50" selected>50</option>
                      <option value="100">100</option>
                    </select>
                  </div>
                  <div class="table-wrap">
                    <table>
                      <thead>
                        <tr>
                          <th class="sticky">SKU</th>
                          <th>Descrição</th>
                          <th class="num">Qtd</th>
                          <th class="num">Preço Médio (R$)</th>
                          <th class="num">Valor Total (R$)</th>
                          <th>Status</th>
                        </tr>
                      </thead>
                      <tbody id="excedentesTable"></tbody>
                    </table>
                  </div>
                  <div class="pagination" id="excedentesPagination"></div>
                </div>
              </section>
            </section>
          </div>
        </section>
      </div>
    </div>
  </main>

  <div id="boot-status" aria-live="polite">
    <strong>Boot:</strong> aguardando…
  </div>

  <dialog id="dlg-excedente">
    <form method="dialog" id="form-exc">
      <h3>Registrar Excedente</h3>
      <div class="field">
        <label for="exc-sku">SKU</label>
        <input id="exc-sku" readonly class="input" />
      </div>
      <div class="field">
        <label for="exc-desc">Descrição</label>
        <input id="exc-desc" required class="input" />
      </div>
      <div class="field">
        <label for="exc-qtd">Qtd</label>
        <input id="exc-qtd" type="number" min="1" value="1" required class="input" />
      </div>
      <div class="field">
        <label for="exc-preco">Preço unitário (R$)</label>
        <input id="exc-preco" type="number" step="0.01" min="0" class="input" />
      </div>
      <div class="field">
        <label for="exc-obs">Observação</label>
        <input id="exc-obs" class="input" />
      </div>
      <menu>
        <button value="cancel" class="btn btn-ghost">Cancelar</button>
        <button id="exc-salvar" value="default" class="btn btn-primary">Salvar excedente</button>
      </menu>
    </form>
  </dialog>

  <button id="btn-settings" class="btn btn-ghost" aria-label="Configurações" title="Configurações" style="position:fixed;right:12px;top:12px">⚙️</button>
  <dialog id="dlg-settings">
    <form method="dialog" class="card" style="min-width:320px">
      <h3>Configurações</h3>
      <div class="field">
        <label><input type="checkbox" id="cfg-hide-scanner" /> Ocultar painel do scanner</label>
      </div>
      <div class="field">
        <label for="cfg-page-size" class="label">Itens por seção (padrão)</label>
        <select id="cfg-page-size" class="input">
          <option>25</option><option selected>50</option><option>100</option><option>200</option>
        </select>
      </div>
      <div class="field">
        <label for="cfg-discount" class="label">Desconto alvo abaixo do preço ML (%)</label>
        <input id="cfg-discount" type="number" class="input" value="25" min="0" max="90" step="1" />
      </div>

      <div class="field">
        <label for="cfg-auction-fee" class="label">Taxa do leilão (%)</label>
        <input id="cfg-auction-fee" type="number" class="input" value="8" min="0" max="50" step="0.1" />
      </div>

      <div class="field">
        <label for="cfg-freight" class="label">Frete total (R$) — opcional</label>
        <input id="cfg-freight" type="number" class="input" value="0" min="0" step="0.01" />
      </div>

      <div class="field">
        <label for="cfg-freight-mode" class="label">Rateio do frete</label>
        <select id="cfg-freight-mode" class="input">
          <option value="por_unidade" selected>Por unidade</option>
          <option value="por_valor">Proporcional ao valor</option>
        </select>
      </div>
      <menu style="display:flex;gap:8px;justify-content:flex-end">
        <button value="cancel" class="btn btn-ghost">Cancelar</button>
        <button value="default" class="btn btn-primary">Salvar</button>
      </menu>
    </form>
  </dialog>

  <dialog id="dlg-indicators">
    <form method="dialog">
      <h3>Selecionar indicadores</h3>
      <div id="metrics-options"></div>
      <menu style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
        <button value="cancel" class="btn btn-ghost">Cancelar</button>
        <button id="apply-indicators" value="default" class="btn btn-primary">Aplicar</button>
      </menu>
    </form>
  </dialog>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script type="module" src="/src/main.js"></script>
</body>
</html>
